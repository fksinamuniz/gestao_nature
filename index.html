<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Produtos de Suplementos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-dark: #1e3a8a;
            --primary-medium: #3b82f6;
            --secondary-dark: #374151;
            --secondary-light: #9ca3af;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --bg-dark: #0f172a;
            --bg-medium: #1e293b;
            --bg-light: #f8fafc;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--secondary-dark);
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            color: var(--secondary-dark);
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .spinner {
            border: 4px solid rgba(0, 0, 0, .1);
            border-left-color: var(--primary-medium);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .metric-card {
            border-left: 5px solid var(--primary-medium);
            position: relative;
            overflow: hidden;
        }
        .metric-card::before {
            content: ''; position: absolute; top: 0; right: 0; width: 100px; height: 100px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(59, 130, 246, 0.02) 100%);
            border-radius: 50%;
            transform: translate(30px, -30px);
        }
        .success-metric { border-left-color: var(--success) !important; }
        .success-metric::before { background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(16, 185, 129, 0.02) 100%); }
        .warning-metric { border-left-color: var(--warning) !important; }
        .warning-metric::before { background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, rgba(245, 158, 11, 0.02) 100%); }
        .danger-metric { border-left-color: var(--danger) !important; }
        .danger-metric::before { background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, rgba(239, 68, 68, 0.02) 100%); }
        
        .input-field, .form-select {
            border-radius: 10px; border: 2px solid #e2e8f0; padding: 0.6rem 1rem;
            transition: all 0.2s ease; background: #ffffff;
        }
        .input-field:focus, .form-select:focus {
            border-color: var(--primary-medium);
            box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.15);
            outline: none;
        }
        
        .btn {
            border-radius: 10px; font-weight: 500; padding: 0.5rem 1rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-medium) 0%, var(--primary-dark) 100%);
            border: none; color: white;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-1px); color: white;
            box-shadow: 0 6px 8px -1px rgba(59, 130, 246, 0.4);
        }
        .btn-secondary {
            background-color: #e2e8f0; color: var(--secondary-dark);
            border-color: #e2e8f0;
        }
        .btn-secondary:hover {
            background-color: #cbd5e1; border-color: #cbd5e1;
        }
        
        .tab {
            padding: 0.75rem 1rem;
            sm:padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--secondary-light);
            border-bottom: 3px solid transparent;
            transition: all 300ms;
        }
        .tab.active {
            color: var(--primary-dark);
            border-bottom-color: var(--primary-medium);
        }
        .tab:hover {
            background-color: rgba(0,0,0,0.03);
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Container Principal -->
    <div class="container mx-auto p-2 sm:p-4 md:p-8">
        <header class="mb-4 text-center flex flex-col items-center">
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold" style="color: var(--primary-dark);">Gestão Integrada</h1>
            <p style="color: var(--secondary-dark);" class="mt-2 text-sm sm:text-base">Gerencie seu estoque, clientes, pedidos e finanças.</p>
        </header>

        <!-- Indicador de Status de Conexão -->
        <div id="session-status" class="text-center text-sm mb-8 p-2 bg-gray-100 rounded-lg" style="color: var(--secondary-light);">
            Conectando...
        </div>

        <!-- Abas de Navegação -->
        <div class="mb-8 border-b border-gray-200">
            <nav class="flex justify-center -mb-px flex-wrap">
                <button id="stock-tab" class="tab active" data-view="stock-view">Estoque</button>
                <button id="clients-tab" class="tab" data-view="clients-view">Clientes</button>
                <button id="orders-tab" class="tab" data-view="orders-view">Pedidos</button>
                <button id="finance-tab" class="tab" data-view="finance-view">Financeiro</button>
            </nav>
        </div>
        
        <main>
            <!-- Visão de Estoque -->
            <div id="stock-view">
                 <!-- Painel de Métricas -->
                <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 md:gap-6 mb-8">
                    <div class="card metric-card col-span-2 sm:col-span-1"><div class="card-body p-4"><h3 class="text-xs sm:text-sm font-medium text-gray-500">Total de Produtos</h3><p id="dashboard-product-count" class="text-2xl md:text-3xl font-semibold text-gray-900 mt-1">0</p></div></div>
                    <div class="card metric-card"><div class="card-body p-4"><h3 class="text-xs sm:text-sm font-medium text-gray-500">Unid. em Estoque</h3><p id="dashboard-total-units" class="text-2xl md:text-3xl font-semibold text-gray-900 mt-1">0</p></div></div>
                    <div class="card metric-card warning-metric"><div class="card-body p-4"><h3 class="text-xs sm:text-sm font-medium text-gray-500">Custo Estoque</h3><p id="dashboard-inventory-cost" class="text-2xl md:text-3xl font-semibold mt-1" style="color: var(--warning)">R$ 0,00</p></div></div>
                    <div class="card metric-card success-metric"><div class="card-body p-4"><h3 class="text-xs sm:text-sm font-medium text-gray-500">Receita Potencial</h3><p id="dashboard-potential-revenue" class="text-2xl md:text-3xl font-semibold mt-1" style="color: var(--success)">R$ 0,00</p></div></div>
                    <div class="card metric-card success-metric"><div class="card-body p-4"><h3 class="text-xs sm:text-sm font-medium text-gray-500">Lucro Potencial</h3><p id="dashboard-potential-profit" class="text-2xl md:text-3xl font-semibold mt-1" style="color: var(--success)">R$ 0,00</p></div></div>
                </div>

                <!-- Painel de Ações do Estoque-->
                <div class="card mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 md:space-x-4 p-4">
                    <div class="w-full md:w-1/3">
                        <input type="text" id="searchInput" placeholder="Buscar por nome ou marca..." class="input-field">
                    </div>
                    <div class="flex w-full md:w-auto space-x-2">
                        <button id="exportStockBtn" class="btn btn-secondary w-1/2 md:w-auto">Exportar</button>
                        <button id="addProductBtn" class="btn btn-primary w-1/2 md:w-auto">Adicionar</button>
                    </div>
                </div>

                <!-- Tabela de Produtos -->
                <div class="card overflow-x-auto p-4">
                    <table class="w-full table-auto">
                        <thead class="border-b-2 border-gray-200">
                            <tr>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500">Produto</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500 hidden md:table-cell">Marca</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500 hidden sm:table-cell">Preço Compra</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500">Preço Venda</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500 hidden sm:table-cell">Lucro/Unid.</th>
                                <th class="p-4 text-center text-sm font-semibold text-gray-500">Estoque</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500 hidden sm:table-cell">Validade</th>
                                <th class="p-4 text-center text-sm font-semibold text-gray-500">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody"></tbody>
                    </table>
                     <div id="no-results-products" class="text-center p-8 text-gray-500 hidden">Nenhum produto encontrado.</div>
                </div>
            </div>

            <!-- Visão de Clientes -->
            <div id="clients-view" class="hidden">
                 <div class="card mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 md:space-x-4 p-4">
                    <div class="w-full md:w-1/3">
                        <input type="text" id="clientSearchInput" placeholder="Buscar por nome ou telefone..." class="input-field">
                    </div>
                    <div class="flex w-full md:w-auto space-x-2">
                        <button id="exportClientsBtn" class="btn btn-secondary w-1/2 md:w-auto">Exportar</button>
                        <button id="addClientBtn" class="btn btn-primary w-1/2 md:w-auto">Adicionar</button>
                    </div>
                </div>
                <div class="card overflow-x-auto p-4">
                    <table class="w-full table-auto">
                        <thead class="border-b-2 border-gray-200">
                            <tr>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500">Nome</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500 hidden sm:table-cell">Telefone</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500">Produto Adquirido</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500 hidden md:table-cell">Valor Pago</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500 hidden md:table-cell">Pagamento</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500 hidden lg:table-cell">Endereço</th>
                                <th class="p-4 text-center text-sm font-semibold text-gray-500">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody"></tbody>
                    </table>
                    <div id="no-results-clients" class="text-center p-8 text-gray-500 hidden">Nenhum cliente encontrado.</div>
                </div>
            </div>
            
            <!-- Visão de Pedidos -->
            <div id="orders-view" class="hidden">
                 <div class="card mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 md:space-x-4 p-4">
                    <div class="w-full md:w-1/3">
                        <input type="text" id="orderSearchInput" placeholder="Buscar por cliente ou produto..." class="input-field">
                    </div>
                    <div class="flex w-full md:w-auto space-x-2">
                        <button id="exportOrdersBtn" class="btn btn-secondary w-1/2 md:w-auto">Exportar</button>
                        <button id="addOrderBtn" class="btn btn-primary w-1/2 md:w-auto">Adicionar</button>
                    </div>
                </div>
                <div class="card overflow-x-auto p-4">
                    <table class="w-full table-auto">
                        <thead class="border-b-2 border-gray-200">
                            <tr>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500">Cliente</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500">Produto</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500 hidden sm:table-cell">Valor Total</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500 hidden md:table-cell">Valor Pago</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500">Restante</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500 hidden lg:table-cell">Data do Pedido</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500 hidden sm:table-cell">Vencimento</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500">Status</th>
                                <th class="p-4 text-center text-sm font-semibold text-gray-500">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody"></tbody>
                    </table>
                    <div id="no-results-orders" class="text-center p-8 text-gray-500 hidden">Nenhum pedido encontrado.</div>
                </div>
            </div>

            <!-- Visão Financeira -->
            <div id="finance-view" class="hidden">
                 <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 md:gap-6 mb-8">
                    <div class="card metric-card col-span-2 sm:col-span-1"><div class="card-body p-4"><h3 class="text-xs sm:text-sm font-medium text-gray-500">Receita Bruta</h3><p id="finance-gross-revenue" class="text-2xl md:text-3xl font-semibold mt-1" style="color:var(--primary-medium)">R$ 0,00</p></div></div>
                    <div class="card metric-card warning-metric"><div class="card-body p-4"><h3 class="text-xs sm:text-sm font-medium text-gray-500">Custos Totais</h3><p id="finance-total-costs" class="text-2xl md:text-3xl font-semibold mt-1" style="color:var(--warning)">R$ 0,00</p></div></div>
                    <div class="card metric-card success-metric"><div class="card-body p-4"><h3 class="text-xs sm:text-sm font-medium text-gray-500">Lucro Bruto</h3><p id="finance-gross-profit" class="text-2xl md:text-3xl font-semibold mt-1" style="color:var(--success)">R$ 0,00</p></div></div>
                    <div class="card metric-card success-metric"><div class="card-body p-4"><h3 class="text-xs sm:text-sm font-medium text-gray-500">Valores Recebidos</h3><p id="finance-amount-received" class="text-2xl md:text-3xl font-semibold mt-1" style="color:var(--success)">R$ 0,00</p></div></div>
                    <div class="card metric-card warning-metric"><div class="card-body p-4"><h3 class="text-xs sm:text-sm font-medium text-gray-500">Valores a Receber</h3><p id="finance-amount-receivable" class="text-2xl md:text-3xl font-semibold mt-1" style="color:var(--warning)">R$ 0,00</p></div></div>
                </div>
                 <div class="card mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 md:space-x-4 p-4">
                    <div class="w-full md:w-1/3">
                        <input type="text" id="financeSearchInput" placeholder="Buscar por cliente ou produto..." class="input-field">
                    </div>
                    <div class="flex w-full md:w-auto space-x-2">
                        <button id="exportFinanceBtn" class="btn btn-secondary w-full">Exportar (CSV)</button>
                    </div>
                </div>
                <div class="card overflow-x-auto p-4">
                    <table class="w-full table-auto">
                        <thead class="border-b-2 border-gray-200">
                            <tr>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500">Data</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500">Cliente</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500 hidden sm:table-cell">Produto</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500">Valor</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500 hidden sm:table-cell">Custo</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-500 hidden md:table-cell">Lucro</th>
                            </tr>
                        </thead>
                        <tbody id="financeTableBody"></tbody>
                    </table>
                     <div id="no-results-finance" class="text-center p-8 text-gray-500 hidden">Nenhuma transação encontrada.</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal para Adicionar/Editar Produto -->
    <div id="productModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden overflow-y-auto p-4">
        <div class="bg-white w-full max-w-lg p-6 md:p-8 rounded-2xl shadow-2xl m-4 transform transition-all scale-95 opacity-0" id="product-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 id="productModalTitle" class="text-2xl font-bold">Adicionar Produto</h2>
                <button id="closeProductModalBtn" class="text-gray-400 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4"><label for="productName" class="block text-sm font-medium text-gray-700 mb-1">Nome do Produto</label><input type="text" id="productName" class="input-field" required></div>
                    <div class="mb-4"><label for="productBrand" class="block text-sm font-medium text-gray-700 mb-1">Marca</label><input type="text" id="productBrand" class="input-field" required></div>
                    <div class="mb-4"><label for="purchasePrice" class="block text-sm font-medium text-gray-700 mb-1">Preço de Compra (R$)</label><input type="number" id="purchasePrice" step="0.01" min="0" class="input-field" required></div>
                    <div class="mb-4"><label for="salePrice" class="block text-sm font-medium text-gray-700 mb-1">Preço de Venda (R$)</label><input type="number" id="salePrice" step="0.01" min="0" class="input-field" required></div>
                    <div class="mb-4"><label for="stock" class="block text-sm font-medium text-gray-700 mb-1">Estoque</label><input type="number" id="stock" min="0" class="input-field" required></div>
                    <div class="mb-4"><label for="expiryDate" class="block text-sm font-medium text-gray-700 mb-1">Data de Validade</label><input type="date" id="expiryDate" class="input-field" required></div>
                </div>
                <div class="mt-6 flex justify-end"><button type="submit" id="saveProductBtn" class="btn btn-primary">Salvar</button></div>
            </form>
        </div>
    </div>
    
    <!-- Modal para Adicionar/Editar Cliente -->
    <div id="clientModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden overflow-y-auto p-4">
        <div class="bg-white w-full max-w-lg p-6 md:p-8 rounded-2xl shadow-2xl m-4 transform transition-all scale-95 opacity-0" id="client-modal-content">
            <div class="flex justify-between items-center mb-6"><h2 id="clientModalTitle" class="text-2xl font-bold">Adicionar Cliente</h2><button id="closeClientModalBtn" class="text-gray-400 hover:text-gray-800 text-3xl">&times;</button></div>
            <form id="clientForm">
                <input type="hidden" id="clientId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4"><label for="clientName" class="block text-sm font-medium text-gray-700 mb-1">Nome</label><input type="text" id="clientName" class="input-field" required></div>
                    <div class="mb-4"><label for="clientPhone" class="block text-sm font-medium text-gray-700 mb-1">Telefone</label><input type="tel" id="clientPhone" class="input-field" required></div>
                     <div class="mb-4 md:col-span-2"><label for="clientProduct" class="block text-sm font-medium text-gray-700 mb-1">Produto Adquirido</label><select id="clientProduct" class="input-field" required></select></div>
                    <div class="mb-4"><label for="clientSaleValue" class="block text-sm font-medium text-gray-700 mb-1">Valor Pago (R$)</label><input type="number" id="clientSaleValue" step="0.01" min="0" class="input-field" required></div>
                    <div class="mb-4"><label for="clientPaymentMethod" class="block text-sm font-medium text-gray-700 mb-1">Forma de Pagamento</label><select id="clientPaymentMethod" class="input-field" required><option>PIX</option><option>Débito</option><option>Crédito</option><option>Dinheiro</option></select></div>
                    <div class="mb-4 md:col-span-2"><label for="clientAddress" class="block text-sm font-medium text-gray-700 mb-1">Endereço de Entrega</label><textarea id="clientAddress" rows="3" class="input-field"></textarea></div>
                </div>
                <div class="mt-6 flex justify-end"><button type="submit" id="saveClientBtn" class="btn btn-primary">Salvar</button></div>
            </form>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Pedido -->
    <div id="orderModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden overflow-y-auto p-4">
        <div class="bg-white w-full max-w-lg p-6 md:p-8 rounded-2xl shadow-2xl m-4 transform transition-all scale-95 opacity-0" id="order-modal-content">
            <div class="flex justify-between items-center mb-6"><h2 id="orderModalTitle" class="text-2xl font-bold">Adicionar Pedido</h2><button id="closeOrderModalBtn" class="text-gray-400 hover:text-gray-800 text-3xl">&times;</button></div>
            <form id="orderForm">
                <input type="hidden" id="orderId"><input type="hidden" id="orderProductStockId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4"><label for="orderClient" class="block text-sm font-medium text-gray-700 mb-1">Cliente</label><select id="orderClient" class="input-field" required></select></div>
                    <div class="mb-4"><label for="orderProduct" class="block text-sm font-medium text-gray-700 mb-1">Produto</label><select id="orderProduct" class="input-field" required></select></div>
                    <div class="mb-4"><label for="orderTotalValue" class="block text-sm font-medium text-gray-700 mb-1">Valor Total (R$)</label><input type="number" id="orderTotalValue" step="0.01" min="0" class="input-field" required></div>
                    <div class="mb-4"><label for="orderAmountPaid" class="block text-sm font-medium text-gray-700 mb-1">Valor de Entrada (R$)</label><input type="number" id="orderAmountPaid" step="0.01" min="0" class="input-field" required></div>
                    <div class="mb-4"><label for="orderRemaining" class="block text-sm font-medium text-gray-700 mb-1">Valor Restante (R$)</label><input type="number" id="orderRemaining" step="0.01" min="0" class="input-field bg-gray-100" readonly></div>
                    <div class="mb-4"><label for="orderDueDate" class="block text-sm font-medium text-gray-700 mb-1">Data de Vencimento</label><input type="date" id="orderDueDate" class="input-field"></div>
                </div>
                <div class="mt-6 flex justify-end"><button type="submit" id="saveOrderBtn" class="btn btn-primary">Salvar</button></div>
            </form>
        </div>
    </div>
    
     <!-- Modal para Gerenciar Recebimento -->
    <div id="paymentModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden overflow-y-auto p-4">
        <div class="bg-white w-full max-w-md p-6 md:p-8 rounded-2xl shadow-2xl m-4 transform transition-all scale-95 opacity-0" id="payment-modal-content">
            <div class="flex justify-between items-center mb-6"><h2 id="paymentModalTitle" class="text-2xl font-bold">Gerenciar Recebimento</h2><button id="closePaymentModalBtn" class="text-gray-400 hover:text-gray-800 text-3xl">&times;</button></div>
            <form id="paymentForm">
                <input type="hidden" id="paymentOrderId">
                <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">Cliente: <span id="paymentClientName" class="font-semibold"></span></p>
                    <p class="text-sm text-gray-600">Valor Total: <span id="paymentTotalValue" class="font-semibold"></span></p>
                    <p class="text-sm text-green-600">Valor Pago: <span id="paymentAmountPaid" class="font-semibold"></span></p>
                    <p class="text-sm text-red-600">Valor Restante: <span id="paymentRemainingValue" class="font-semibold"></span></p>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    <div class="mb-2"><label for="paymentAmountReceived" class="block text-sm font-medium text-gray-700 mb-1">Novo Pagamento (R$)</label><input type="number" id="paymentAmountReceived" step="0.01" min="0" class="input-field" placeholder="0.00"></div>
                    <div class="mb-2"><label for="paymentStatus" class="block text-sm font-medium text-gray-700 mb-1">Situação</label><select id="paymentStatus" class="input-field" required><option>A receber</option><option>Recebido</option><option>Atraso</option></select></div>
                    <div class="mb-2"><label for="paymentNotes" class="block text-sm font-medium text-gray-700 mb-1">Observação</label><textarea id="paymentNotes" rows="3" class="input-field"></textarea></div>
                </div>
                <div class="mt-6 flex justify-end"><button type="submit" id="savePaymentBtn" class="btn btn-primary">Salvar</button></div>
            </form>
        </div>
    </div>

    <!-- Custom confirmation dialog -->
    <div id="confirmDialog" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="card w-full max-w-sm m-4 p-6">
            <h3 class="text-lg font-semibold mb-4" id="confirmTitle">Confirmar Ação</h3>
            <p id="confirmMessage" class="text-gray-700">Você tem certeza?</p>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="confirmCancel" class="btn btn-secondary">Cancelar</button>
                <button id="confirmOk" class="btn text-white" style="background: var(--danger);">Deletar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let productsCollectionRef, clientsCollectionRef, ordersCollectionRef;
        let unsubscribeProducts, unsubscribeClients, unsubscribeOrders;
        let allProducts = [], allClients = [], allOrders = [];

        const sessionStatusDiv = document.getElementById('session-status');
        const stockTab = document.getElementById('stock-tab');
        const clientsTab = document.getElementById('clients-tab');
        const ordersTab = document.getElementById('orders-tab');
        const financeTab = document.getElementById('finance-tab');
        const stockView = document.getElementById('stock-view');
        const clientsView = document.getElementById('clients-view');
        const ordersView = document.getElementById('orders-view');
        const financeView = document.getElementById('finance-view');
        const addProductBtn = document.getElementById('addProductBtn');
        const productModal = document.getElementById('productModal');
        const productModalContent = document.getElementById('product-modal-content');
        const closeProductModalBtn = document.getElementById('closeProductModalBtn');
        const productForm = document.getElementById('productForm');
        const productModalTitle = document.getElementById('productModalTitle');
        const saveProductBtn = document.getElementById('saveProductBtn');
        const productsTableBody = document.getElementById('productsTableBody');
        const searchInput = document.getElementById('searchInput');
        const noResultsProductsDiv = document.getElementById('no-results-products');
        const exportStockBtn = document.getElementById('exportStockBtn');
        const addClientBtn = document.getElementById('addClientBtn');
        const clientModal = document.getElementById('clientModal');
        const clientModalContent = document.getElementById('client-modal-content');
        const closeClientModalBtn = document.getElementById('closeClientModalBtn');
        const clientForm = document.getElementById('clientForm');
        const clientModalTitle = document.getElementById('clientModalTitle');
        const saveClientBtn = document.getElementById('saveClientBtn');
        const clientsTableBody = document.getElementById('clientsTableBody');
        const clientSearchInput = document.getElementById('clientSearchInput');
        const noResultsClientsDiv = document.getElementById('no-results-clients');
        const clientProductSelect = document.getElementById('clientProduct');
        const exportClientsBtn = document.getElementById('exportClientsBtn');
        const addOrderBtn = document.getElementById('addOrderBtn');
        const orderModal = document.getElementById('orderModal');
        const orderModalContent = document.getElementById('order-modal-content');
        const closeOrderModalBtn = document.getElementById('closeOrderModalBtn');
        const orderForm = document.getElementById('orderForm');
        const saveOrderBtn = document.getElementById('saveOrderBtn');
        const ordersTableBody = document.getElementById('ordersTableBody');
        const orderSearchInput = document.getElementById('orderSearchInput');
        const noResultsOrdersDiv = document.getElementById('no-results-orders');
        const exportOrdersBtn = document.getElementById('exportOrdersBtn');
        const orderClientSelect = document.getElementById('orderClient');
        const orderProductSelect = document.getElementById('orderProduct');
        const financeGrossRevenue = document.getElementById('finance-gross-revenue');
        const financeTotalCosts = document.getElementById('finance-total-costs');
        const financeGrossProfit = document.getElementById('finance-gross-profit');
        const financeAmountReceived = document.getElementById('finance-amount-received');
        const financeAmountReceivable = document.getElementById('finance-amount-receivable');
        const financeTableBody = document.getElementById('financeTableBody');
        const financeSearchInput = document.getElementById('financeSearchInput');
        const noResultsFinanceDiv = document.getElementById('no-results-finance');
        const exportFinanceBtn = document.getElementById('exportFinanceBtn');
        const paymentModal = document.getElementById('paymentModal');
        const paymentModalContent = document.getElementById('payment-modal-content');
        const closePaymentModalBtn = document.getElementById('closePaymentModalBtn');
        const paymentForm = document.getElementById('paymentForm');
        const savePaymentBtn = document.getElementById('savePaymentBtn');
        const confirmDialog = document.getElementById('confirmDialog');
        const confirmOk = document.getElementById('confirmOk');
        const confirmCancel = document.getElementById('confirmCancel');
        const confirmMessage = document.getElementById('confirmMessage');
        const dashboardProductCount = document.getElementById('dashboard-product-count');
        const dashboardTotalUnits = document.getElementById('dashboard-total-units');
        const dashboardInventoryCost = document.getElementById('dashboard-inventory-cost');
        const dashboardPotentialRevenue = document.getElementById('dashboard-potential-revenue');
        const dashboardPotentialProfit = document.getElementById('dashboard-potential-profit');

        const switchView = (viewId) => {
            [stockView, clientsView, ordersView, financeView].forEach(v => v.classList.add('hidden'));
            [stockTab, clientsTab, ordersTab, financeTab].forEach(t => t.classList.remove('active'));
            document.getElementById(viewId).classList.remove('hidden');
            document.getElementById(viewId.replace('-view', '-tab')).classList.add('active');
        };

        const openModal = (modal, content) => {
            modal.classList.remove('hidden');
            setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); }, 10);
        };
        const closeModal = (modal, content, form) => {
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                if (form) form.reset();
            }, 200);
        };
        
        const populateSelect = (selectElement, data, valueField, textField) => {
            selectElement.innerHTML = `<option value="">Selecione uma opção</option>`;
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueField];
                option.dataset.full = JSON.stringify(item);
                option.textContent = item[textField];
                selectElement.appendChild(option);
            });
        };

        let confirmCallback = null;
        const hideConfirmDialog = () => { confirmDialog.classList.add('hidden'); confirmCallback = null; };
        const showConfirmDialog = (message, onConfirm) => { confirmMessage.textContent = message; confirmCallback = onConfirm; confirmDialog.classList.remove('hidden'); };
        const handleConfirmClick = () => { if (typeof confirmCallback === 'function') { confirmCallback(); } hideConfirmDialog(); };

        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(parseFloat(value) || 0);
        const formatDate = (dateString) => { if (!dateString) return 'N/A'; const [year, month, day] = dateString.split('-'); return `${day}/${month}/${year}`; };
        
        const calculateOrderStatus = (order) => {
            const total = parseFloat(order.totalValue) || 0;
            const paid = parseFloat(order.amountPaid) || 0;
            if (paid >= total) return { text: 'Recebido', color: 'bg-green-100 text-green-800' };
            if (order.dueDate) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const dueDate = new Date(order.dueDate + 'T00:00:00-03:00');
                if (today > dueDate) return { text: 'Atraso', color: 'bg-red-100 text-red-800' };
            }
            return { text: 'A receber', color: 'bg-yellow-100 text-yellow-800' };
        };
        
        const updateDashboard = (products) => {
            if (!products || products.length === 0) {
                dashboardProductCount.textContent = '0'; dashboardTotalUnits.textContent = '0';
                dashboardInventoryCost.textContent = formatCurrency(0); dashboardPotentialRevenue.textContent = formatCurrency(0);
                dashboardPotentialProfit.textContent = formatCurrency(0); return;
            }
            const totalUnits = products.reduce((sum, p) => sum + (parseInt(p.stock, 10) || 0), 0);
            const inventoryCost = products.reduce((sum, p) => sum + ((parseFloat(p.purchasePrice) || 0) * (parseInt(p.stock, 10) || 0)), 0);
            const potentialRevenue = products.reduce((sum, p) => sum + ((parseFloat(p.salePrice) || 0) * (parseInt(p.stock, 10) || 0)), 0);
            const potentialProfit = potentialRevenue - inventoryCost;
            dashboardProductCount.textContent = products.length; dashboardTotalUnits.textContent = totalUnits;
            dashboardInventoryCost.textContent = formatCurrency(inventoryCost); dashboardPotentialRevenue.textContent = formatCurrency(potentialRevenue);
            dashboardPotentialProfit.textContent = formatCurrency(potentialProfit);
        };
        
        const updateFinanceDashboard = (orders, products) => {
            if(!orders || !products){ return; }
            let grossRevenue = 0, totalCosts = 0, amountReceived = 0;
            orders.forEach(order => {
                const product = products.find(p => p.id === order.productId);
                grossRevenue += parseFloat(order.totalValue) || 0;
                amountReceived += parseFloat(order.amountPaid) || 0;
                if(product){ totalCosts += parseFloat(product.purchasePrice) || 0; }
            });
            const grossProfit = grossRevenue - totalCosts;
            const amountReceivable = grossRevenue - amountReceived;
            financeGrossRevenue.textContent = formatCurrency(grossRevenue);
            financeTotalCosts.textContent = formatCurrency(totalCosts);
            financeGrossProfit.textContent = formatCurrency(grossProfit);
            financeAmountReceived.textContent = formatCurrency(amountReceived);
            financeAmountReceivable.textContent = formatCurrency(amountReceivable);
        };

        const renderProducts = (products) => {
            productsTableBody.innerHTML = '';
            noResultsProductsDiv.classList.add('hidden');
            if (products.length === 0) {
                 productsTableBody.innerHTML = '<tr><td colspan="8" class="text-center p-8 text-gray-500">Nenhum produto cadastrado.</td></tr>';
                return;
            }
            products.forEach(product => {
                const purchasePrice = parseFloat(product.purchasePrice) || 0;
                const salePrice = parseFloat(product.salePrice) || 0;
                const stock = parseInt(product.stock, 10) || 0;
                const unitProfit = salePrice - purchasePrice;
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-100';
                tr.innerHTML = `
                    <td class="p-4 text-gray-900 font-medium">${product.name}</td>
                    <td class="p-4 text-gray-700 hidden md:table-cell">${product.brand}</td>
                    <td class="p-4 text-gray-700 hidden sm:table-cell">${formatCurrency(purchasePrice)}</td>
                    <td class="p-4 text-gray-700">${formatCurrency(salePrice)}</td>
                    <td class="p-4 font-medium hidden sm:table-cell" style="color: ${unitProfit >= 0 ? 'var(--success)' : 'var(--danger)'};">${formatCurrency(unitProfit)}</td>
                    <td class="p-4 text-center text-gray-700">${stock}</td>
                    <td class="p-4 text-gray-700 hidden sm:table-cell">${formatDate(product.expiryDate)}</td>
                    <td class="p-4 text-center">
                        <div class="flex justify-center items-center space-x-1">
                            <button class="edit-product-btn text-gray-400 hover:text-blue-600 p-1" data-id="${product.id}"><i class="fas fa-edit pointer-events-none"></i></button>
                            <button class="delete-product-btn text-gray-400 hover:text-red-600 p-1" data-id="${product.id}"><i class="fas fa-trash pointer-events-none"></i></button>
                        </div>
                    </td>
                `;
                productsTableBody.appendChild(tr);
            });
        };
        const filterProducts = () => {
             const searchTerm = searchInput.value.toLowerCase();
            const filtered = allProducts.filter(p => p.name.toLowerCase().includes(searchTerm) || p.brand.toLowerCase().includes(searchTerm));
            renderProducts(filtered);
             if(filtered.length === 0 && allProducts.length > 0) { noResultsProductsDiv.classList.remove('hidden'); } else { noResultsProductsDiv.classList.add('hidden');}
        };

        const renderClients = (clients) => {
            clientsTableBody.innerHTML = '';
            noResultsClientsDiv.classList.add('hidden');
            if (clients.length === 0) {
                clientsTableBody.innerHTML = '<tr><td colspan="7" class="text-center p-8 text-gray-500">Nenhum cliente cadastrado.</td></tr>';
                return;
            }
            clients.forEach(client => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-100';
                tr.innerHTML = `
                    <td class="p-4 text-gray-900 font-medium">${client.name}</td>
                    <td class="p-4 text-gray-700 hidden sm:table-cell">${client.phone}</td>
                    <td class="p-4 text-gray-700">${client.product}</td>
                    <td class="p-4 text-gray-700 hidden md:table-cell">${formatCurrency(client.saleValue)}</td>
                    <td class="p-4 text-gray-700 hidden md:table-cell">${client.paymentMethod}</td>
                    <td class="p-4 text-gray-700 truncate max-w-xs hidden lg:table-cell">${client.address}</td>
                    <td class="p-4 text-center">
                        <div class="flex justify-center items-center space-x-1">
                            <button class="edit-client-btn text-gray-400 hover:text-blue-600 p-1" data-id="${client.id}"><i class="fas fa-edit pointer-events-none"></i></button>
                            <button class="delete-client-btn text-gray-400 hover:text-red-600 p-1" data-id="${client.id}"><i class="fas fa-trash pointer-events-none"></i></button>
                        </div>
                    </td>
                `;
                clientsTableBody.appendChild(tr);
            });
        };
        const filterClients = () => {
            const searchTerm = clientSearchInput.value.toLowerCase();
            const filtered = allClients.filter(c => c.name.toLowerCase().includes(searchTerm) || c.phone.toLowerCase().includes(searchTerm));
            renderClients(filtered);
            if(filtered.length === 0 && allClients.length > 0) { noResultsClientsDiv.classList.remove('hidden'); } else { noResultsClientsDiv.classList.add('hidden');}
        };
        
        const renderOrders = (orders) => {
            ordersTableBody.innerHTML = '';
            noResultsOrdersDiv.classList.add('hidden');
            if (orders.length === 0) {
                ordersTableBody.innerHTML = '<tr><td colspan="9" class="text-center p-8 text-gray-500">Nenhum pedido cadastrado.</td></tr>';
                return;
            }
            orders.forEach(order => {
                const total = parseFloat(order.totalValue) || 0;
                const paid = parseFloat(order.amountPaid) || 0;
                const remaining = total - paid;
                const status = calculateOrderStatus(order);
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-100';
                tr.innerHTML = `
                    <td class="p-4 text-gray-900 font-medium">${order.clientName}</td>
                    <td class="p-4 text-gray-700">${order.productName}</td>
                    <td class="p-4 text-gray-700 hidden sm:table-cell">${formatCurrency(total)}</td>
                    <td class="p-4 font-medium hidden md:table-cell" style="color: var(--success);">${formatCurrency(paid)}</td>
                    <td class="p-4 font-medium" style="color: var(--danger);">${formatCurrency(remaining)}</td>
                    <td class="p-4 text-gray-700 hidden lg:table-cell">${formatDate(order.orderDate)}</td>
                    <td class="p-4 text-gray-700 hidden sm:table-cell">${formatDate(order.dueDate)}</td>
                    <td class="p-4"><span class="status-badge ${status.color}">${status.text}</span></td>
                    <td class="p-4 text-center">
                        <div class="flex justify-center items-center space-x-1">
                            <button class="payment-order-btn text-gray-400 hover:text-blue-600 p-1" data-id="${order.id}" title="Gerenciar Recebimento"><i class="fas fa-dollar-sign pointer-events-none"></i></button>
                            <button class="delete-order-btn text-gray-400 hover:text-red-600 p-1" data-id="${order.id}" data-product-id="${order.productId}" title="Deletar Pedido"><i class="fas fa-trash pointer-events-none"></i></button>
                        </div>
                    </td>
                `;
                ordersTableBody.appendChild(tr);
            });
        };
        const filterOrders = () => {
            const searchTerm = orderSearchInput.value.toLowerCase();
            const filtered = allOrders.filter(o => o.clientName.toLowerCase().includes(searchTerm) || o.productName.toLowerCase().includes(searchTerm));
            renderOrders(filtered);
            if(filtered.length === 0 && allOrders.length > 0) { noResultsOrdersDiv.classList.remove('hidden'); } else { noResultsOrdersDiv.classList.add('hidden');}
        };

        const renderFinanceTransactions = (orders, products) => {
            financeTableBody.innerHTML = '';
            noResultsFinanceDiv.classList.add('hidden');
            if (orders.length === 0) {
                financeTableBody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-gray-500">Nenhuma transação encontrada.</td></tr>';
                return;
            }

            const transactions = orders.map(order => {
                const product = products.find(p => p.id === order.productId);
                const cost = product ? (parseFloat(product.purchasePrice) || 0) : 0;
                const total = parseFloat(order.totalValue) || 0;
                const profit = total - cost;
                return { date: order.orderDate, client: order.clientName, product: order.productName, value: total, cost: cost, profit: profit };
            });

            const searchTerm = financeSearchInput.value.toLowerCase();
            const filteredTransactions = transactions.filter(t => t.client.toLowerCase().includes(searchTerm) || t.product.toLowerCase().includes(searchTerm));

            const toRender = filteredTransactions.length > 0 || searchTerm.length > 0 ? filteredTransactions : transactions;

            if (toRender.length === 0) {
                financeTableBody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-gray-500">Nenhuma transação encontrada para a busca.</td></tr>';
                noResultsFinanceDiv.classList.remove('hidden');
                return;
            }

            toRender.forEach(t => {
                 const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-100';
                tr.innerHTML = `
                    <td class="p-4 text-gray-700">${formatDate(t.date)}</td>
                    <td class="p-4 text-gray-900 font-medium">${t.client}</td>
                    <td class="p-4 text-gray-700 hidden sm:table-cell">${t.product}</td>
                    <td class="p-4 font-medium" style="color: var(--primary-dark);">${formatCurrency(t.value)}</td>
                    <td class="p-4 font-medium hidden sm:table-cell" style="color: var(--warning);">${formatCurrency(t.cost)}</td>
                    <td class="p-4 font-medium hidden md:table-cell" style="color: var(--success);">${formatCurrency(t.profit)}</td>
                `;
                financeTableBody.appendChild(tr);
            });
        };

        const handleProductFormSubmit = async (e) => {
             e.preventDefault();
            const productId = document.getElementById('productId').value;
            const productData = { name: document.getElementById('productName').value, brand: document.getElementById('productBrand').value, purchasePrice: document.getElementById('purchasePrice').value, salePrice: document.getElementById('salePrice').value, stock: document.getElementById('stock').value, expiryDate: document.getElementById('expiryDate').value };
            try {
                if (productId) { await updateDoc(doc(productsCollectionRef, productId), productData); } else { await addDoc(productsCollectionRef, productData); }
                closeModal(productModal, productModalContent, productForm);
            } catch (error) { console.error("Error saving product: ", error); }
        };

        const handleClientFormSubmit = async (e) => {
            e.preventDefault();
            const clientId = document.getElementById('clientId').value;
            const clientData = { name: document.getElementById('clientName').value, phone: document.getElementById('clientPhone').value, product: document.getElementById('clientProduct').value, saleValue: document.getElementById('clientSaleValue').value, paymentMethod: document.getElementById('clientPaymentMethod').value, address: document.getElementById('clientAddress').value };
            try {
                if (clientId) { await updateDoc(doc(clientsCollectionRef, clientId), clientData); } else { await addDoc(clientsCollectionRef, clientData); }
                closeModal(clientModal, clientModalContent, clientForm);
            } catch (error) { console.error("Error saving client: ", error); }
        };

        const handleOrderFormSubmit = async (e) => {
            e.preventDefault();
            const selectedClientOption = orderClient.options[orderClient.selectedIndex];
            const selectedProductOption = orderProduct.options[orderProduct.selectedIndex];
            if (!selectedClientOption.value || !selectedProductOption.value) { alert("Por favor, selecione um cliente e um produto."); return; }

            const client = JSON.parse(selectedClientOption.dataset.full);
            const product = JSON.parse(selectedProductOption.dataset.full);
            
            const orderData = { clientId: client.id, clientName: client.name, productId: product.id, productName: product.name, totalValue: document.getElementById('orderTotalValue').value, amountPaid: document.getElementById('orderAmountPaid').value, orderDate: new Date().toISOString().split('T')[0], dueDate: document.getElementById('orderDueDate').value, paymentStatus: 'A receber', notes: '' };

            try {
                await runTransaction(db, async (transaction) => {
                    const productRef = doc(productsCollectionRef, product.id);
                    const productDoc = await transaction.get(productRef);
                    if (!productDoc.exists()) { throw "Produto não encontrado!"; }
                    const newStock = productDoc.data().stock - 1;
                    if (newStock < 0) { throw "Produto sem estoque!"; }
                    transaction.update(productRef, { stock: newStock });
                    transaction.set(doc(ordersCollectionRef), orderData);
                });
                closeModal(orderModal, orderModalContent, orderForm);
            } catch (error) { console.error("Erro ao salvar pedido: ", error); alert("Erro ao salvar pedido: " + error); }
        };
        
        const handlePaymentFormSubmit = async (e) => {
            e.preventDefault();
            const orderId = document.getElementById('paymentOrderId').value;
            const order = allOrders.find(o => o.id === orderId);
            if(!order) return;
            const received = parseFloat(document.getElementById('paymentAmountReceived').value) || 0;
            const currentPaid = parseFloat(order.amountPaid) || 0;
            const newAmountPaid = currentPaid + received;
            const paymentData = { amountPaid: newAmountPaid, paymentStatus: document.getElementById('paymentStatus').value, notes: document.getElementById('paymentNotes').value };
            try {
                await updateDoc(doc(ordersCollectionRef, orderId), paymentData);
                closeModal(paymentModal, paymentModalContent, paymentForm);
            } catch(error) { console.error("Erro ao salvar recebimento: ", error); alert("Erro ao salvar recebimento."); }
        };

        const handleTableClick = (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const id = target.dataset.id;
            
            if (target.classList.contains('edit-product-btn')) {
                const product = allProducts.find(p => p.id === id);
                if (product) {
                    productModalTitle.textContent = "Editar Produto"; saveProductBtn.textContent = "Salvar Alterações";
                    document.getElementById('productId').value = product.id; document.getElementById('productName').value = product.name;
                    document.getElementById('productBrand').value = product.brand; document.getElementById('purchasePrice').value = product.purchasePrice;
                    document.getElementById('salePrice').value = product.salePrice; document.getElementById('stock').value = product.stock;
                    document.getElementById('expiryDate').value = product.expiryDate;
                    openModal(productModal, productModalContent);
                }
            } else if (target.classList.contains('delete-product-btn')) {
                showConfirmDialog("Tem certeza que deseja deletar este produto?", async () => {
                    try { await deleteDoc(doc(productsCollectionRef, id)); } catch (error) { console.error("Error deleting product: ", error); }
                });
            } else if (target.classList.contains('edit-client-btn')) {
                const client = allClients.find(c => c.id === id);
                if (client) {
                    clientModalTitle.textContent = "Editar Cliente"; saveClientBtn.textContent = "Salvar Alterações";
                    populateSelect(clientProductSelect, allProducts, 'name', 'name');
                    document.getElementById('clientId').value = client.id; document.getElementById('clientName').value = client.name;
                    document.getElementById('clientPhone').value = client.phone; document.getElementById('clientProduct').value = client.product;
                    document.getElementById('clientSaleValue').value = client.saleValue; document.getElementById('clientPaymentMethod').value = client.paymentMethod;
                    document.getElementById('clientAddress').value = client.address;
                    openModal(clientModal, clientModalContent);
                }
            } else if (target.classList.contains('delete-client-btn')) {
                showConfirmDialog("Tem certeza que deseja deletar este cliente?", async () => {
                    try { await deleteDoc(doc(clientsCollectionRef, id)); } catch (error) { console.error("Error deleting client: ", error); }
                });
            } else if (target.classList.contains('payment-order-btn')) {
                const order = allOrders.find(o => o.id === id);
                if(order){
                    document.getElementById('paymentOrderId').value = order.id;
                    document.getElementById('paymentClientName').textContent = order.clientName;
                    const total = parseFloat(order.totalValue) || 0;
                    const paid = parseFloat(order.amountPaid) || 0;
                    document.getElementById('paymentTotalValue').textContent = formatCurrency(total);
                    document.getElementById('paymentAmountPaid').textContent = formatCurrency(paid);
                    document.getElementById('paymentRemainingValue').textContent = formatCurrency(total - paid);
                    document.getElementById('paymentStatus').value = calculateOrderStatus(order).text;
                    document.getElementById('paymentNotes').value = order.notes || '';
                    openModal(paymentModal, paymentModalContent);
                }
            } else if (target.classList.contains('delete-order-btn')) {
                showConfirmDialog("Deletar um pedido irá retornar o produto ao estoque. Confirma?", async () => {
                    try {
                        await runTransaction(db, async (transaction) => {
                            const orderRef = doc(ordersCollectionRef, id);
                            const productRef = doc(productsCollectionRef, target.dataset.productId);
                            const productDoc = await transaction.get(productRef);
                            if (productDoc.exists()) {
                                const newStock = (productDoc.data().stock || 0) + 1;
                                transaction.update(productRef, { stock: newStock });
                            }
                            transaction.delete(orderRef);
                        });
                    } catch (error) { console.error("Error deleting order: ", error); alert("Erro ao deletar pedido: " + error); }
                });
            }
        };
        
        const exportToCsv = (filename, rows) => {
            if (!rows || rows.length === 0) { alert("Não há dados para exportar."); return; }
            const separator = ',';
            const keys = Object.keys(rows[0]);
            const csvContent = keys.join(separator) + '\n' + rows.map(row => {
                return keys.map(k => {
                    let cell = row[k] === null || row[k] === undefined ? '' : row[k];
                    cell = cell.toString().replace(/"/g, '""');
                    if (cell.search(/("|,|\n)/g) >= 0) { cell = `"${cell}"`; }
                    return cell;
                }).join(separator);
            }).join('\n');
            const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        const setupFirestoreListeners = () => {
            if (unsubscribeProducts) unsubscribeProducts(); 
            if (unsubscribeClients) unsubscribeClients();
            if (unsubscribeOrders) unsubscribeOrders();

            productsCollectionRef = collection(db, `artifacts/${appId}/public/data/products`);
            clientsCollectionRef = collection(db, `artifacts/${appId}/public/data/clients`);
            ordersCollectionRef = collection(db, `artifacts/${appId}/public/data/orders`);
            
            unsubscribeProducts = onSnapshot(productsCollectionRef, (snapshot) => {
                allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateDashboard(allProducts);
                filterProducts();
                updateFinanceDashboard(allOrders, allProducts);
                renderFinanceTransactions(allOrders, allProducts);
            }, (error) => { console.error("Error fetching products: ", error); });

            unsubscribeClients = onSnapshot(clientsCollectionRef, (snapshot) => {
                allClients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filterClients();
            }, (error) => { console.error("Error fetching clients: ", error); });

             unsubscribeOrders = onSnapshot(ordersCollectionRef, (snapshot) => {
                allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filterOrders();
                updateFinanceDashboard(allOrders, allProducts);
                renderFinanceTransactions(allOrders, allProducts);
            }, (error) => { console.error("Error fetching orders: ", error); });
        };
        
        const initialize = async () => {
             try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } else { await signInAnonymously(auth); }
                if (!auth.currentUser) throw new Error("Authentication failed.");
                setupFirestoreListeners();
                sessionStatusDiv.innerHTML = `<span class="font-semibold" style="color:var(--success)">✔ Conectado</span> | ID Compartilhado: <span class="font-mono bg-gray-200 px-1 rounded">${appId}</span>`;
            } catch (error) { 
                console.error("Initialization Error:", error); 
                 sessionStatusDiv.innerHTML = `<span class="font-semibold" style="color:var(--danger)">✖ Erro de Conexão</span>`;
            }
        };

        stockTab.addEventListener('click', () => switchView('stock-view'));
        clientsTab.addEventListener('click', () => switchView('clients-view'));
        ordersTab.addEventListener('click', () => switchView('orders-view'));
        financeTab.addEventListener('click', () => switchView('finance-view'));
        
        addProductBtn.addEventListener('click', () => { 
            productForm.reset(); productModalTitle.textContent = "Adicionar Produto";
            saveProductBtn.textContent = "Salvar"; document.getElementById('productId').value = '';
            openModal(productModal, productModalContent); 
        });
        addClientBtn.addEventListener('click', () => { 
            clientForm.reset(); clientModalTitle.textContent = "Adicionar Cliente";
            saveClientBtn.textContent = "Salvar"; document.getElementById('clientId').value = '';
            populateSelect(clientProductSelect, allProducts, 'name', 'name');
            openModal(clientModal, clientModalContent); 
        });
        addOrderBtn.addEventListener('click', () => { 
            orderForm.reset();
            document.getElementById('orderModalTitle').textContent = "Adicionar Pedido";
            document.getElementById('saveOrderBtn').textContent = "Salvar";
            document.getElementById('orderId').value = '';
            populateSelect(orderClientSelect, allClients, 'id', 'name');
            populateSelect(orderProductSelect, allProducts.filter(p => p.stock > 0), 'id', 'name');
            openModal(orderModal, orderModalContent); 
        });
        
        orderProductSelect.addEventListener('change', (e) => {
            const selectedOption = e.target.options[e.target.selectedIndex];
            if (selectedOption.dataset.full) {
                const product = JSON.parse(selectedOption.dataset.full);
                document.getElementById('orderTotalValue').value = product.salePrice;
                document.getElementById('orderAmountPaid').dispatchEvent(new Event('input'));
            }
        });
        
        ['orderTotalValue', 'orderAmountPaid'].forEach(id => {
            document.getElementById(id).addEventListener('input', () => {
                const total = parseFloat(document.getElementById('orderTotalValue').value) || 0;
                const paid = parseFloat(document.getElementById('orderAmountPaid').value) || 0;
                document.getElementById('orderRemaining').value = (total - paid).toFixed(2);
            });
        });

        exportStockBtn.addEventListener('click', () => exportToCsv('estoque.csv', allProducts.map(p => ({ 'Produto': p.name, 'Marca': p.brand, 'Preco de Compra': formatCurrency(p.purchasePrice), 'Preco de Venda': formatCurrency(p.salePrice), 'Estoque': p.stock, 'Validade': formatDate(p.expiryDate) }))));
        exportClientsBtn.addEventListener('click', () => exportToCsv('clientes.csv', allClients.map(c => ({ 'Nome': c.name, 'Telefone': c.phone, 'Produto Adquirido': c.product, 'Valor Pago': formatCurrency(c.saleValue), 'Forma de Pagamento': c.paymentMethod, 'Endereco': c.address }))));
        exportOrdersBtn.addEventListener('click', () => exportToCsv('pedidos.csv', allOrders.map(o => { const total = parseFloat(o.totalValue) || 0; const paid = parseFloat(o.amountPaid) || 0; return { 'Cliente': o.clientName, 'Produto': o.productName, 'Valor Total': formatCurrency(total), 'Valor Pago': formatCurrency(paid), 'Restante': formatCurrency(total-paid), 'Data do Pedido': formatDate(o.orderDate), 'Vencimento': formatDate(o.dueDate), 'Status': calculateOrderStatus(o).text }; })));
        exportFinanceBtn.addEventListener('click', () => exportToCsv('financeiro.csv', allOrders.map(order => { const product = allProducts.find(p => p.id === order.productId); const cost = product ? (parseFloat(product.purchasePrice) || 0) : 0; const total = parseFloat(order.totalValue) || 0; return { 'Data': formatDate(order.orderDate), 'Cliente': order.clientName, 'Produto': order.productName, 'Tipo': 'Venda', 'Valor': formatCurrency(total), 'Custo': formatCurrency(cost), 'Lucro': formatCurrency(total-cost) }; })));
        
        closeProductModalBtn.addEventListener('click', () => closeModal(productModal, productModalContent, productForm));
        productModal.addEventListener('click', (e) => { if (e.target === productModal) closeModal(productModal, productModalContent, productForm); });
        closeClientModalBtn.addEventListener('click', () => closeModal(clientModal, clientModalContent, clientForm));
        clientModal.addEventListener('click', (e) => { if (e.target === clientModal) closeModal(clientModal, clientModalContent, clientForm); });
        closeOrderModalBtn.addEventListener('click', () => closeModal(orderModal, orderModalContent, orderForm));
        orderModal.addEventListener('click', (e) => { if (e.target === orderModal) closeModal(orderModal, orderModalContent, orderForm); });
        closePaymentModalBtn.addEventListener('click', () => closeModal(paymentModal, paymentModalContent, paymentForm));
        paymentModal.addEventListener('click', (e) => { if (e.target === paymentModal) closeModal(paymentModal, paymentModalContent, paymentForm); });
        
        confirmOk.addEventListener('click', handleConfirmClick);
        confirmCancel.addEventListener('click', hideConfirmDialog);
        confirmDialog.addEventListener('click', (e) => { if(e.target === confirmDialog) hideConfirmDialog(); });

        productForm.addEventListener('submit', handleProductFormSubmit);
        clientForm.addEventListener('submit', handleClientFormSubmit);
        orderForm.addEventListener('submit', handleOrderFormSubmit);
        paymentForm.addEventListener('submit', handlePaymentFormSubmit);

        productsTableBody.addEventListener('click', handleTableClick);
        clientsTableBody.addEventListener('click', handleTableClick);
        ordersTableBody.addEventListener('click', handleTableClick);

        searchInput.addEventListener('input', filterProducts);
        clientSearchInput.addEventListener('input', filterClients);
        orderSearchInput.addEventListener('input', filterOrders);
        financeSearchInput.addEventListener('input', () => renderFinanceTransactions(allOrders, allProducts));
        
        initialize();

    </script>
</body>
</html>

